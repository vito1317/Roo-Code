# Roo Code å®Œæ•´å·¥ä½œæµç¨‹ç¯„ä¾‹

> **ç¯„ä¾‹**: ä½¿ç”¨è€…è¼¸å…¥ã€Œå¹«æˆ‘å»ºç«‹ä¸€å€‹ç™»å…¥é é¢ã€

---

## ğŸ”„ å®Œæ•´ç«¯åˆ°ç«¯æµç¨‹åœ–

```mermaid
sequenceDiagram
    autonumber
    participant U as ğŸ‘¤ ä½¿ç”¨è€…
    participant UI as ğŸ’¬ Chat UI
    participant FSM as ğŸ”„ StateMachine
    participant ARCH as ğŸŸ¦ Architect
    participant DES as ğŸ¨ Designer
    participant MCP as ğŸ”Œ McpHub
    participant FW as ğŸ“¦ figma-write
    participant WS as ğŸŒ‰ WebSocket
    participant PLG as ğŸ§© Plugin
    participant FIG as ğŸ¨ Figma
    participant BLD as ğŸŸ© Builder
    participant QA as ğŸŸ¨ QA
    participant BRWS as ğŸŒ Browser
    participant SEC as ğŸŸ¥ Sentinel

    rect rgb(230, 245, 255)
        Note over U,SEC: === éšæ®µ 1ï¼šä½¿ç”¨è€…è¼¸å…¥ ===
        U->>UI: ã€Œå¹«æˆ‘å»ºç«‹ä¸€å€‹ç™»å…¥é é¢ã€
        UI->>FSM: å•Ÿå‹•ä»»å‹™
        FSM->>FSM: setState(IDLE â†’ ARCHITECT)
    end

    rect rgb(230, 255, 240)
        Note over U,SEC: === éšæ®µ 2ï¼šArchitect è¦åŠƒ ===
        FSM->>ARCH: é–‹å§‹è¦åŠƒ
        ARCH->>ARCH: åˆ†æéœ€æ±‚
        Note right of ARCH: åˆ¤æ–·éœ€è¦ UI è¨­è¨ˆ<br/>needsDesign = true
        ARCH->>ARCH: ç”Ÿæˆ architectPlan
        Note right of ARCH: - ç™»å…¥è¡¨å–®è¨­è¨ˆ<br/>- ä½¿ç”¨è€…èªè­‰ API<br/>- éŒ¯èª¤è™•ç†é‚è¼¯
        ARCH->>FSM: handoff(designSpecs)
        FSM->>FSM: setState(ARCHITECT â†’ DESIGNER)
    end

    rect rgb(255, 240, 245)
        Note over U,SEC: === éšæ®µ 3ï¼šDesigner è¨­è¨ˆ UI ===
        FSM->>DES: é–‹å§‹è¨­è¨ˆ
        
        Note over DES,FIG: --- 3.1 å‰µå»º Frame ---
        DES->>MCP: use_mcp_tool("figma-write", "create_frame", {name:"Login", w:400, h:600})
        MCP->>FW: callTool()
        FW->>WS: sendToPlugin("create_frame", args)
        WS->>PLG: ws.send({action, args})
        PLG->>FIG: figma.createFrame()
        FIG-->>PLG: frameId: "123:456"
        PLG-->>WS: {ok:true, nodeId:"123:456"}
        WS-->>FW: resolve(result)
        FW-->>MCP: toolResult
        MCP-->>DES: nodeId="123:456"

        Note over DES,FIG: --- 3.2 æ·»åŠ æ¨™é¡Œæ–‡å­— ---
        DES->>MCP: use_mcp_tool("figma-write", "add_text", {content:"ç™»å…¥", fontSize:24})
        MCP->>FW: callTool()
        FW->>WS: sendToPlugin("add_text", args)
        WS->>PLG: ws.send({action, args})
        PLG->>FIG: figma.createText()
        FIG-->>PLG: textId: "123:789"
        PLG-->>WS: {ok:true, nodeId:"123:789"}
        WS-->>FW: resolve(result)
        FW-->>MCP: toolResult
        MCP-->>DES: nodeId="123:789"

        Note over DES,FIG: --- 3.3 å‰µå»ºè¼¸å…¥æ¡† ---
        DES->>MCP: use_mcp_tool("figma-write", "create_rectangle", {w:320, h:48})
        MCP->>FW: callTool()
        FW->>WS: sendToPlugin("create_rectangle", args)
        WS->>PLG: ws.send()
        PLG->>FIG: figma.createRectangle()
        FIG-->>PLG: rectId
        PLG-->>WS: result
        WS-->>FW: resolve
        FW-->>MCP: toolResult
        MCP-->>DES: nodeId

        DES->>MCP: use_mcp_tool("figma-write", "set_corner_radius", {nodeId, radius:8})
        MCP->>FW: callTool()
        FW->>WS: sendToPlugin()
        WS->>PLG: ws.send()
        PLG->>FIG: node.cornerRadius = 8
        FIG-->>PLG: ok
        PLG-->>WS: result
        WS-->>FW: resolve
        FW-->>MCP: toolResult
        MCP-->>DES: success

        Note over DES,FIG: --- 3.4 å‰µå»ºæŒ‰éˆ• ---
        DES->>MCP: use_mcp_tool("figma-write", "create_rectangle", {w:320, h:48})
        DES->>MCP: use_mcp_tool("figma-write", "set_fill", {hex:"#3B82F6"})
        DES->>MCP: use_mcp_tool("figma-write", "add_text", {content:"ç™»å…¥", color:"#FFFFFF"})

        DES->>FSM: handoff(designSpecs)
        FSM->>FSM: setState(DESIGNER â†’ DESIGN_REVIEW)
    end

    rect rgb(255, 250, 230)
        Note over U,SEC: === éšæ®µ 4ï¼šè¨­è¨ˆå¯©æŸ¥ ===
        FSM->>ARCH: å¯©æŸ¥è¨­è¨ˆ
        ARCH->>ARCH: æª¢æŸ¥ designSpecs
        alt è¨­è¨ˆéœ€ä¿®æ”¹
            ARCH-->>FSM: rejected
            FSM->>DES: é‡æ–°è¨­è¨ˆ (max 3æ¬¡)
        else è¨­è¨ˆé€šé
            ARCH-->>FSM: approved
            FSM->>FSM: setState(DESIGN_REVIEW â†’ BUILDER)
        end
    end

    rect rgb(230, 255, 230)
        Note over U,SEC: === éšæ®µ 5ï¼šBuilder å¯¦ä½œ ===
        FSM->>BLD: é–‹å§‹å¯¦ä½œ
        
        Note right of BLD: æ ¹æ“š designSpecs å¯¦ä½œ
        BLD->>BLD: write_to_file("LoginPage.vue")
        Note right of BLD: <template><br/>  <div class="login-container"><br/>    <h1>ç™»å…¥</h1><br/>    <input placeholder="å¸³è™Ÿ"/><br/>    <button>ç™»å…¥</button><br/>  </div><br/></template>
        
        BLD->>BLD: write_to_file("auth.ts")
        Note right of BLD: export async function login(username, password) {...}
        
        BLD->>BLD: execute_command("npm run build")
        Note right of BLD: âœ“ Build successful
        
        BLD->>BLD: execute_command("npm run test")
        Note right of BLD: âœ“ Tests passed
        
        BLD->>FSM: handoff(builderTestContext)
        FSM->>FSM: setState(BUILDER â†’ CODE_REVIEW)
    end

    rect rgb(255, 245, 230)
        Note over U,SEC: === éšæ®µ 6ï¼šç¨‹å¼ç¢¼å¯©æŸ¥ ===
        FSM->>ARCH: å¯©æŸ¥ç¨‹å¼ç¢¼
        ARCH->>ARCH: æª¢æŸ¥å¯¦ä½œå“è³ª
        alt éœ€è¦ä¿®æ”¹
            ARCH-->>FSM: rejected
            FSM->>BLD: ä¿®æ­£å•é¡Œ
        else é€šé
            ARCH-->>FSM: approved
            FSM->>FSM: setState(CODE_REVIEW â†’ QA)
        end
    end

    rect rgb(255, 255, 220)
        Note over U,SEC: === éšæ®µ 7ï¼šQA æ¸¬è©¦ ===
        FSM->>QA: é–‹å§‹æ¸¬è©¦
        
        QA->>BRWS: browser_action("launch", {url:"http://localhost:3000/login"})
        BRWS-->>QA: é é¢å·²è¼‰å…¥
        
        QA->>BRWS: browser_action("screenshot")
        BRWS-->>QA: screenshot.png
        Note right of QA: è¦–è¦ºé©—è­‰ï¼š<br/>âœ“ æ¨™é¡Œé¡¯ç¤ºæ­£ç¢º<br/>âœ“ è¼¸å…¥æ¡†å­˜åœ¨<br/>âœ“ æŒ‰éˆ•é¡è‰²æ­£ç¢º
        
        QA->>BRWS: browser_action("type", {selector:"input", text:"test@example.com"})
        BRWS-->>QA: è¼¸å…¥å®Œæˆ
        
        QA->>BRWS: browser_action("click", {selector:"button"})
        BRWS-->>QA: é»æ“Šå®Œæˆ
        
        QA->>BRWS: browser_action("screenshot")
        BRWS-->>QA: result_screenshot.png
        Note right of QA: E2E æ¸¬è©¦çµæœï¼š<br/>âœ“ è¡¨å–®æäº¤æˆåŠŸ<br/>âœ“ ç„¡ console éŒ¯èª¤
        
        QA->>FSM: handoff(qaAuditContext)
        FSM->>FSM: setState(QA â†’ TEST_REVIEW)
    end

    rect rgb(245, 240, 255)
        Note over U,SEC: === éšæ®µ 8ï¼šæ¸¬è©¦å¯©æŸ¥ ===
        FSM->>ARCH: å¯©æŸ¥æ¸¬è©¦çµæœ
        alt æ¸¬è©¦å¤±æ•—
            ARCH-->>FSM: failed (max 3æ¬¡)
            FSM->>BLD: ä¿®æ­£ bug
        else æ¸¬è©¦é€šé
            ARCH-->>FSM: passed
            FSM->>FSM: setState(TEST_REVIEW â†’ SENTINEL)
        end
    end

    rect rgb(255, 235, 235)
        Note over U,SEC: === éšæ®µ 9ï¼šå®‰å…¨æƒæ ===
        FSM->>SEC: é–‹å§‹å®‰å…¨å¯©è¨ˆ
        
        Note right of SEC: SAST éœæ…‹åˆ†æï¼š
        SEC->>SEC: æƒæ XSS æ¼æ´
        SEC->>SEC: æƒæ SQL Injection
        SEC->>SEC: æƒææ•æ„Ÿè³‡æ–™æ´©éœ²
        
        Note right of SEC: DAST å‹•æ…‹æ¸¬è©¦ï¼š
        SEC->>BRWS: æ¨¡æ“¬æ”»æ“Šæ¸¬è©¦
        BRWS-->>SEC: ç„¡æ¼æ´ç™¼ç¾
        
        SEC->>FSM: handoff(sentinelResult)
        FSM->>FSM: setState(SENTINEL â†’ FINAL_REVIEW)
    end

    rect rgb(230, 255, 230)
        Note over U,SEC: === éšæ®µ 10ï¼šæœ€çµ‚å¯©æŸ¥ ===
        FSM->>ARCH: æœ€çµ‚å®‰å…¨å¯©æŸ¥
        alt ç™¼ç¾æ¼æ´
            ARCH-->>FSM: vulnerabilities (max 2æ¬¡)
            FSM->>BLD: ä¿®å¾©æ¼æ´
        else å®‰å…¨é€šé
            ARCH-->>FSM: approved
            FSM->>FSM: setState(FINAL_REVIEW â†’ COMPLETED)
        end
    end

    rect rgb(220, 255, 220)
        Note over U,SEC: === âœ… å®Œæˆ ===
        FSM->>UI: ä»»å‹™å®Œæˆ
        UI->>U: ã€Œç™»å…¥é é¢å·²å»ºç«‹å®Œæˆï¼ã€
        Note right of U: ç”¢å‡ºç‰©ï¼š<br/>â€¢ Figma è¨­è¨ˆç¨¿<br/>â€¢ LoginPage.vue<br/>â€¢ auth.ts<br/>â€¢ é€šéæ¸¬è©¦å ±å‘Š<br/>â€¢ å®‰å…¨æƒæå ±å‘Š
    end
```

---

## ğŸ“Š ç‹€æ…‹æµè½‰ç°¡åœ–

```mermaid
flowchart LR
    A((IDLE)) --> B[Architect]
    B --> C[Designer]
    C --> D{Design Review}
    D -->|reject| C
    D -->|approve| E[Builder]
    E --> F{Code Review}
    F -->|reject| E
    F -->|approve| G[QA]
    G --> H{Test Review}
    H -->|fail| E
    H -->|pass| I[Sentinel]
    I --> J{Final Review}
    J -->|vuln| E
    J -->|approve| K((DONE))
    
    D -->|max 3x| L((BLOCKED))
    H -->|max 3x| L
    J -->|max 2x| L
    
    style A fill:#6B7280,color:#fff
    style B fill:#3B82F6,color:#fff
    style C fill:#EC4899,color:#fff
    style D fill:#F472B6,color:#fff
    style E fill:#10B981,color:#fff
    style F fill:#34D399,color:#fff
    style G fill:#F59E0B,color:#fff
    style H fill:#FBBF24,color:#fff
    style I fill:#EF4444,color:#fff
    style J fill:#F87171,color:#fff
    style K fill:#22C55E,color:#fff
    style L fill:#991B1B,color:#fff
```

---

## ğŸ“‹ å„éšæ®µ MCP å·¥å…·èª¿ç”¨æ‘˜è¦

| éšæ®µ | Agent | å·¥å…· | èªªæ˜ |
|------|-------|------|------|
| 3.1 | Designer | `create_frame` | å»ºç«‹ç™»å…¥é é¢å®¹å™¨ |
| 3.2 | Designer | `add_text` | æ·»åŠ ã€Œç™»å…¥ã€æ¨™é¡Œ |
| 3.3 | Designer | `create_rectangle` | å»ºç«‹å¸³è™Ÿè¼¸å…¥æ¡† |
| 3.3 | Designer | `set_corner_radius` | è¨­å®šåœ“è§’ 8px |
| 3.4 | Designer | `create_rectangle` | å»ºç«‹ç™»å…¥æŒ‰éˆ• |
| 3.4 | Designer | `set_fill` | è¨­å®šæŒ‰éˆ•è—è‰²èƒŒæ™¯ |
| 3.4 | Designer | `add_text` | æŒ‰éˆ•æ–‡å­— |
| 5 | Builder | `write_to_file` | å¯«å…¥ Vue å…ƒä»¶ |
| 5 | Builder | `execute_command` | å»ºç½®èˆ‡æ¸¬è©¦ |
| 7 | QA | `browser_action` | E2E è¦–è¦ºé©—è­‰ |
| 9 | Sentinel | `browser_action` | å‹•æ…‹å®‰å…¨æ¸¬è©¦ |

---

## ğŸ”€ HandoffContext è³‡æ–™å‚³é

```mermaid
flowchart TB
    subgraph HC["HandoffContext è³‡æ–™çµæ§‹"]
        AP["architectPlan<br/><small>éœ€æ±‚åˆ†æã€ä»»å‹™æ‹†è§£</small>"]
        DS["designSpecs<br/><small>Figma nodeIdsã€æ¨£å¼è¦æ ¼</small>"]
        BT["builderTestContext<br/><small>æª”æ¡ˆè·¯å¾‘ã€æ¸¬è©¦çµæœ</small>"]
        QA["qaAuditContext<br/><small>æˆªåœ–ã€E2E å ±å‘Š</small>"]
        SR["sentinelResult<br/><small>SAST/DAST å ±å‘Š</small>"]
    end
    
    ARCH[Architect] -->|"ç”¢å‡º"| AP
    AP -->|"å‚³é"| DES[Designer]
    DES -->|"ç”¢å‡º"| DS
    DS -->|"å‚³é"| BLD[Builder]
    BLD -->|"ç”¢å‡º"| BT
    BT -->|"å‚³é"| QAE[QA]
    QAE -->|"ç”¢å‡º"| QA
    QA -->|"å‚³é"| SEC[Sentinel]
    SEC -->|"ç”¢å‡º"| SR
    
    style AP fill:#3B82F6,color:#fff
    style DS fill:#EC4899,color:#fff
    style BT fill:#10B981,color:#fff
    style QA fill:#F59E0B,color:#fff
    style SR fill:#EF4444,color:#fff
```

---

## âš ï¸ éŒ¯èª¤èˆ‡é‡è©¦æµç¨‹

```mermaid
flowchart TB
    subgraph RETRY["é‡è©¦æ©Ÿåˆ¶"]
        DR["Design Review<br/>æœ€å¤š 3 æ¬¡"]
        TR["Test Review<br/>æœ€å¤š 3 æ¬¡"]
        FR["Final Review<br/>æœ€å¤š 2 æ¬¡"]
    end
    
    DR -->|"reject"| DES[Designer é‡æ–°è¨­è¨ˆ]
    DES --> DR
    
    TR -->|"fail"| BLD[Builder ä¿®å¾©]
    BLD --> QA[QA é‡æ¸¬]
    QA --> TR
    
    FR -->|"vuln"| BLD2[Builder ä¿®å¾©æ¼æ´]
    BLD2 --> SEC[Sentinel é‡æƒ]
    SEC --> FR
    
    DR -->|"è¶…é 3 æ¬¡"| BLOCKED((BLOCKED))
    TR -->|"è¶…é 3 æ¬¡"| BLOCKED
    FR -->|"è¶…é 2 æ¬¡"| BLOCKED
    
    BLOCKED -->|"äººå·¥ä»‹å…¥"| RESUME[æ¢å¾©æµç¨‹]
    
    style BLOCKED fill:#991B1B,color:#fff
    style RESUME fill:#22C55E,color:#fff
```
