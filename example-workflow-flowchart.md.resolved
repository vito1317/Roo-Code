# Roo Code å®Œæ•´æ•´åˆæµç¨‹åœ–

> ç¯„ä¾‹ï¼šã€Œå¹«æˆ‘å»ºç«‹ä¸€å€‹ç™»å…¥é é¢ã€
> Spec Mode + Sentinel Multi-Agent + UIDesignCanvas å®Œæ•´æµç¨‹

---

## ğŸ”„ å®Œæ•´æ•´åˆåºåˆ—åœ–

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant SP as SpecMode
    participant CP as ContextProvider
    participant FS as .specs/
    participant WF as WorkflowManager
    participant SM as StateMachine
    participant AR as Architect
    participant DE as Designer
    participant MCP as McpHub
    participant UDC as UIDesignCanvas
    participant BL as Builder
    participant QA as QA
    participant SE as Sentinel

    %% ========== SPEC MODE PHASE 1 ==========
    rect rgb(230, 245, 255)
        Note over U,SE: Phase 1 Requirements
        U->>SP: /spec å¹«æˆ‘å»ºç«‹ç™»å…¥é é¢
        SP->>CP: checkSpecFilesStatus
        CP->>FS: check .specs/ dir
        FS-->>CP: requirementsExists=false
        CP->>CP: determineCurrentPhase => requirements
        CP-->>SP: inject Phase1 Prompt

        SP->>SP: analyze user input
        Note right of SP: è­˜åˆ¥åŠŸèƒ½éœ€æ±‚<br/>å¸³å¯†ç™»å…¥ OAuth

        loop each Section
            SP->>FS: write_to_file APPEND
        end

        SP->>FS: complete requirements.md
        SP->>WF: handleSpecFileCreated
        WF->>U: Continue to Design?
        U-->>WF: Continue
    end

    %% ========== SPEC MODE PHASE 2 ==========
    rect rgb(255, 240, 245)
        Note over U,SE: Phase 2 Design
        WF->>SP: createSpecModeTask designPrompt
        SP->>CP: checkSpecFilesStatus
        CP-->>SP: requirementsExists=true designExists=false
        CP->>CP: determineCurrentPhase => design

        SP->>FS: read_file requirements.md
        FS-->>SP: requirements content

        SP->>SP: create system design
        Note right of SP: ç³»çµ±æ¶æ§‹åœ–<br/>ER Diagram<br/>API è¨­è¨ˆ<br/>UI çµæ§‹

        SP->>FS: write_to_file design.md
        SP->>WF: handleSpecFileCreated
        WF->>U: Continue to Tasks?
        U-->>WF: Continue
    end

    %% ========== SPEC MODE PHASE 3 ==========
    rect rgb(230, 255, 230)
        Note over U,SE: Phase 3 Tasks
        WF->>SP: createSpecModeTask tasksPrompt
        SP->>CP: checkSpecFilesStatus
        CP-->>SP: tasksExists=false
        CP->>CP: determineCurrentPhase => tasks

        SP->>FS: read_file requirements.md
        SP->>FS: read_file design.md

        SP->>SP: breakdown tasks
        Note right of SP: TASK-001 å°ˆæ¡ˆæ¶æ§‹<br/>TASK-002 è³‡æ–™åº«<br/>TASK-003 Auth API<br/>TASK-004 UIè¨­è¨ˆ<br/>TASK-005 å‰ç«¯å¯¦ä½œ

        SP->>FS: write_to_file tasks.md
        SP->>WF: handleSpecFileCreated
        WF->>U: Execute from Panel
    end

    %% ========== PHASE 4 EXECUTION ==========
    rect rgb(255, 255, 220)
        Note over U,SE: Phase 4 Execution
        U->>WF: Start TASK-004 è¨­è¨ˆç™»å…¥é é¢ UI
        WF->>WF: startIndividualTask
        WF->>SM: setMode sentinel-architect
        SM->>SM: setState ARCHITECT
    end

    %% ========== ARCHITECT PHASE ==========
    rect rgb(230, 240, 255)
        Note over U,SE: Architect Phase with needsDesign Decision
        SM->>AR: start Architect Agent
        AR->>FS: read_file design.md
        AR->>FS: read_file tasks.md TASK-004
        FS-->>AR: ä»»å‹™å…§å®¹ è¨­è¨ˆç™»å…¥é é¢ UI

        AR->>AR: analyze task requirements
        AR->>FS: write_to_file plan.md
        Note right of AR: è¨ˆç•«å…§å®¹<br/>1. é–‹å•Ÿè¨­è¨ˆå·¥å…·<br/>2. å»ºç«‹ç™»å…¥è¡¨å–®<br/>3. æ·»åŠ  UI å…ƒç´ <br/>4. åŒ¯å‡ºç¨‹å¼ç¢¼

        Note over AR,MCP: Step needsDesign åˆ¤æ–·
        AR->>AR: detect keywords
        Note right of AR: é—œéµå­—åµæ¸¬<br/>UI/ä»‹é¢/è¨­è¨ˆ/é é¢<br/>login/form/button<br/>=> ç¬¦åˆ UI ä»»å‹™

        alt UI keywords found needsDesign=true
            AR->>AR: needsDesign = true
            
            Note over AR,MCP: Step æª¢æŸ¥è¨­è¨ˆå·¥å…·å¯ç”¨æ€§
            AR->>MCP: checkMcpConnectionStatus
            MCP-->>AR: connections list
            
            alt UIDesignCanvas connected
                AR->>AR: designPlatform = UIDesignCanvas
                Note right of AR: å„ªå…ˆå…§å»ºå·¥å…·<br/>port 4420 SSE
                AR->>SM: handoff needsDesign=true platform=UIDesignCanvas
                SM->>SM: setState DESIGNER
            else Figma connected
                AR->>AR: designPlatform = Figma
                Note right of AR: å¤–éƒ¨ Figma<br/>port 3055 WebSocket
                AR->>SM: handoff needsDesign=true platform=Figma
                SM->>SM: setState DESIGNER
            else No design tool
                AR->>AR: designPlatform = none
                Note right of AR: ç„¡è¨­è¨ˆå·¥å…·<br/>è·³éè¨­è¨ˆéšæ®µ
                AR->>SM: handoff needsDesign=false skipDesign=true
                SM->>SM: setState BUILDER
            end
        else No UI keywords needsDesign=false
            AR->>AR: needsDesign = false
            Note right of AR: ç´”å¾Œç«¯/API ä»»å‹™<br/>ç„¡éœ€è¨­è¨ˆ
            AR->>SM: handoff needsDesign=false
            SM->>SM: setState BUILDER
        end
    end

    %% ========== DESIGNER PHASE ==========
    rect rgb(255, 235, 245)
        Note over U,SE: Designer Phase with UIDesignCanvas
        SM->>DE: start Designer Agent
        DE->>MCP: checkConnection UIDesignCanvas
        MCP-->>DE: connected on 4420

        DE->>MCP: use_mcp_tool new_design
        MCP->>UDC: POST new_design name=LoginPage
        UDC-->>MCP: designId=login-001

        DE->>MCP: use_mcp_tool create_frame
        MCP->>UDC: POST create_frame 400x500
        UDC->>UDC: render in webview
        UDC-->>MCP: frameId=frame_001

        DE->>MCP: use_mcp_tool create_text
        MCP->>UDC: POST create_text content=ç™»å…¥
        UDC-->>MCP: textId=text_001

        DE->>MCP: use_mcp_tool create_rectangle
        MCP->>UDC: POST create_rectangle input email

        DE->>MCP: use_mcp_tool create_rectangle
        MCP->>UDC: POST create_rectangle input password

        DE->>MCP: use_mcp_tool create_rectangle
        MCP->>UDC: POST create_rectangle button

        DE->>MCP: use_mcp_tool set_style
        MCP->>UDC: POST set_style fill=3B82F6
        UDC-->>MCP: style applied

        DE->>MCP: use_mcp_tool export_html
        MCP->>UDC: POST export_html
        UDC->>UDC: generateHTML
        UDC-->>MCP: html content

        DE->>MCP: use_mcp_tool export_react
        MCP->>UDC: POST export_react
        UDC-->>MCP: react component

        DE->>SM: handoff designSpecs
        SM->>SM: setState BUILDER
    end

    %% ========== BUILDER PHASE ==========
    rect rgb(230, 255, 235)
        Note over U,SE: Builder Phase
        SM->>BL: start Builder Agent
        BL->>FS: read_file plan.md
        BL->>BL: read designSpecs

        BL->>FS: write_to_file src/pages/Login.vue
        Note right of BL: æ ¹æ“šåŒ¯å‡ºç¨‹å¼ç¢¼<br/>å¯¦ä½œ Vue å…ƒä»¶

        BL->>BL: execute_command npm run test
        BL-->>BL: tests passed

        BL->>SM: handoff builderTestContext
        SM->>SM: setState QA
    end

    %% ========== QA PHASE ==========
    rect rgb(255, 250, 230)
        Note over U,SE: QA Phase
        SM->>QA: start QA Agent

        QA->>QA: browser_action launch localhost:3000/login
        QA->>QA: browser_action screenshot
        QA->>QA: compare with design

        QA->>QA: browser_action type email
        QA->>QA: browser_action type password
        QA->>QA: browser_action click login button
        QA-->>QA: login success

        QA->>SM: handoff qaAuditContext
        SM->>SM: setState SENTINEL
    end

    %% ========== SENTINEL PHASE ==========
    rect rgb(255, 235, 235)
        Note over U,SE: Sentinel Phase
        SM->>SE: start Sentinel Agent

        SE->>SE: SAST scan Login.vue
        Note right of SE: XSS check<br/>CSRF check<br/>å¯†ç¢¼è™•ç†

        SE->>SE: DAST test
        Note right of SE: SQL Injection<br/>XSS Attack<br/>HTTPS check

        SE->>FS: write_to_file security-report.md
        SE->>SM: handoff securityResult=pass
        SM->>SM: setState COMPLETED
    end

    %% ========== COMPLETE ==========
    rect rgb(220, 255, 220)
        Note over U,SE: Complete and Update Spec
        SM->>WF: task completed
        WF->>FS: update tasks.md TASK-004 done
        WF->>U: TASK-004 å®Œæˆ Continue TASK-005?

        alt More tasks
            U-->>WF: Continue next task
            WF->>SM: start TASK-005
        else All done
            U-->>WF: Finish
            WF->>U: æ‰€æœ‰ä»»å‹™å·²å®Œæˆ
        end
    end
```

---

## ğŸ“Š æµç¨‹éšæ®µç¸½è¦½

| éšæ®µ                 | æ­¥é©Ÿæ•¸ | ä¸»è¦ç”¢å‡º               |
| -------------------- | ------ | ---------------------- |
| Phase 1 Requirements | 1-8    | .specs/requirements.md |
| Phase 2 Design       | 9-14   | .specs/design.md       |
| Phase 3 Tasks        | 15-20  | .specs/tasks.md        |
| Phase 4 Execution    | 21-22  | å•Ÿå‹• Sentinel          |
| Architect            | 23-28  | plan.md + needsDesign  |
| Designer             | 29-42  | UI è¨­è¨ˆ + åŒ¯å‡ºç¨‹å¼ç¢¼   |
| Builder              | 43-47  | ç¨‹å¼ç¢¼å¯¦ä½œ             |
| QA                   | 48-53  | æ¸¬è©¦é©—è­‰               |
| Sentinel             | 54-58  | å®‰å…¨å ±å‘Š               |
| Complete             | 59-62  | æ›´æ–° tasks.md          |
