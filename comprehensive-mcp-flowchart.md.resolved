# Roo Code å®Œæ•´ç³»çµ±æ¶æ§‹æµç¨‹åœ–

> **å°ˆæ¡ˆç‰ˆæœ¬**: Sentinel Edition v7.50+  
> **æ–‡æª”æ›´æ–°æ—¥æœŸ**: 2026-01-29

---

## ğŸ“Š å®Œæ•´ç³»çµ±æ¶æ§‹æµç¨‹åœ– (All-in-One)

```mermaid
flowchart TB
    %% ================ ä½¿ç”¨è€…è¼¸å…¥å±¤ ================
    subgraph USER_LAYER["ğŸ‘¤ ä½¿ç”¨è€…è¼¸å…¥å±¤"]
        direction LR
        USER_INPUT[("ä½¿ç”¨è€…éœ€æ±‚")]
        SLASH_CMD["/architect /code /test"]
    end

    %% ================ VS Code Extension å±¤ ================
    subgraph VSCODE_LAYER["ğŸ’» VS Code Extension"]
        direction TB
        ACTIVATE["Extension Activation"]
        PROVIDER["ClineProvider"]
        CHAT_UI["Chat Interface"]
        ACTIVATE --> PROVIDER
        PROVIDER <--> CHAT_UI
    end

    %% ================ æ ¸å¿ƒç·¨æ’å±¤ ================
    subgraph ORCHESTRATION["ğŸ›ï¸ ç·¨æ’å±¤"]
        direction TB
        FSM[("StateMachine")]
        HANDOFF["HandoffContext"]
        ACM["AgentContextManager"]
        TASK["Task.ts"]
        FSM <--> HANDOFF
        FSM <--> ACM
        FSM <--> TASK
    end

    %% ================ Multi-Agent å·¥ä½œæµå±¤ ================
    subgraph AGENTS["ğŸ¤– Multi-Agent å·¥ä½œæµ"]
        direction TB
        
        subgraph PHASE1["Phase 1: è¦åŠƒè¨­è¨ˆ"]
            IDLE((IDLE))
            ARCHITECT["ğŸŸ¦ Architect"]
            DESIGNER["ğŸ¨ Designer"]
            DESIGN_REVIEW["Design Review"]
        end
        
        subgraph PHASE2["Phase 2: å¯¦ä½œ"]
            BUILDER["ğŸŸ© Builder"]
            ARCH_REVIEW_CODE["Code Review"]
        end
        
        subgraph PHASE3["Phase 3: æ¸¬è©¦"]
            QA["ğŸŸ¨ QA Engineer"]
            TEST_REVIEW["Test Review"]
        end
        
        subgraph PHASE4["Phase 4: å®‰å…¨"]
            SENTINEL["ğŸŸ¥ Sentinel"]
            FINAL_REVIEW["Final Review"]
        end
        
        COMPLETED((âœ… DONE))
        BLOCKED(("ğŸš« BLOCKED"))
    end

    %% ================ è‡ªè¨‚ç¾©å·¥å…·å±¤ ================
    subgraph CUSTOM_TOOLS["ğŸ› ï¸ è‡ªè¨‚ç¾©å·¥å…· 26+"]
        direction TB
        
        subgraph FILE_TOOLS["æª”æ¡ˆæ“ä½œ"]
            READ_FILE["read_file"]
            WRITE_FILE["write_to_file"]
            EDIT_FILE["edit_file"]
            LIST_FILES["list_files"]
            SEARCH_FILES["search_files"]
            CODEBASE_SEARCH["codebase_search"]
        end
        
        subgraph EDIT_TOOLS["ç¨‹å¼ç¢¼ä¿®æ”¹"]
            APPLY_DIFF["apply_diff"]
            APPLY_PATCH["apply_patch"]
            SEARCH_REPLACE["search_replace"]
            SAR["search_and_replace"]
            ADJUST_LAYOUT["adjust_layout"]
        end
        
        subgraph EXEC_TOOLS["åŸ·è¡Œå·¥å…·"]
            EXEC_CMD["execute_command"]
            START_BG["background_service"]
            BROWSER_ACTION["browser_action"]
            GEN_IMAGE["generate_image"]
        end
        
        subgraph MCP_TOOLS["MCP èª¿ç”¨"]
            USE_MCP["use_mcp_tool"]
            PARALLEL_MCP["parallel_mcp_calls"]
            ACCESS_RESOURCE["access_mcp_resource"]
            PARALLEL_UI["parallel_ui_tasks"]
        end
        
        subgraph FLOW_TOOLS["æµç¨‹æ§åˆ¶"]
            HANDOFF_TOOL["handoff_context"]
            SWITCH_MODE["switch_mode"]
            NEW_TASK["new_task"]
            ATTEMPT_COMP["attempt_completion"]
            ASK_QUESTION["ask_followup"]
        end
        
        subgraph MISC_TOOLS["å…¶ä»–"]
            RUN_SLASH["run_slash_command"]
            FETCH_INST["fetch_instructions"]
            TODO_LIST["update_todo_list"]
        end
    end

    %% ================ MCP å”è­°å±¤ ================
    subgraph MCP_LAYER["ğŸ”Œ MCP å”è­°å±¤"]
        direction TB
        MCP_HUB["McpHub"]
        MCP_SERVER_MGR["McpServerManager"]
        PUI_SERVICE["ParallelUIService"]
        AGENT_CTX["AgentContextManager"]
        STDIO["stdio"]
        SSE["SSE"]
        MCP_HUB <--> MCP_SERVER_MGR
        PUI_SERVICE <--> AGENT_CTX
        MCP_HUB <--> STDIO
        MCP_HUB <--> SSE
    end

    %% ================ MCP ä¼ºæœå™¨å±¤ ================
    subgraph MCP_SERVERS["ğŸŒ MCP ä¼ºæœå™¨"]
        direction TB
        
        subgraph FIGMA_MCP["Figma MCP"]
            FW_BRIDGE["figma-write-bridge<br/>:3055"]
            TTF["TalkToFigma"]
        end
        
        subgraph OTHER_MCP["å…¶ä»– MCP"]
            PP_SERVER["penpot-mcp<br/>:4401/:4402"]
            UI_SERVER["mcp-ui-server"]
        end
    end

    %% ================ WebSocket Bridge ================
    subgraph WS_BRIDGE["ğŸŒ‰ WebSocket Bridge"]
        WSS["WebSocketServer :3055"]
        PENDING_MAP["Pending Map"]
        WSS <--> PENDING_MAP
    end

    %% ================ Figma Plugin ================
    subgraph PLUGIN_LAYER["ğŸ§© Figma Plugin"]
        UI_HTML["ui.html"]
        SANDBOX["plugin.js"]
        UI_HTML <-->|"postMessage"| SANDBOX
    end

    %% ================ å¹³å°å±¤ ================
    subgraph PLATFORM_LAYER["ğŸ¨ å¹³å°"]
        FIGMA_CANVAS[("Figma")]
        PENPOT_EDITOR[("Penpot")]
        VSCODE_CHAT[("VS Code Chat")]
    end

    %% ================ ç€è¦½å™¨å±¤ ================
    subgraph BROWSER_LAYER["ğŸŒ ç€è¦½å™¨"]
        BROWSER_SVC["BrowserService"]
        SCREENSHOT["æˆªåœ–"]
        NAVIGATE["å°èˆª"]
        INTERACT["äº’å‹•"]
        BROWSER_SVC --> SCREENSHOT
        BROWSER_SVC --> NAVIGATE
        BROWSER_SVC --> INTERACT
    end

    %% ================ é€£æ¥ç·š ================
    USER_INPUT --> ACTIVATE
    SLASH_CMD --> ACTIVATE
    PROVIDER --> FSM
    PROVIDER --> TASK
    
    FSM -->|"start()"| IDLE
    IDLE --> ARCHITECT
    ARCHITECT -->|"needsDesign"| DESIGNER
    ARCHITECT -->|"noDesign"| BUILDER
    DESIGNER --> DESIGN_REVIEW
    DESIGN_REVIEW -->|"reject"| DESIGNER
    DESIGN_REVIEW -->|"approve"| BUILDER
    DESIGN_REVIEW -->|"max retry"| BLOCKED
    BUILDER --> ARCH_REVIEW_CODE
    ARCH_REVIEW_CODE -->|"reject"| BUILDER
    ARCH_REVIEW_CODE -->|"approve"| QA
    QA --> TEST_REVIEW
    TEST_REVIEW -->|"fail"| BUILDER
    TEST_REVIEW -->|"pass"| SENTINEL
    TEST_REVIEW -->|"max retry"| BLOCKED
    SENTINEL --> FINAL_REVIEW
    FINAL_REVIEW -->|"vuln"| BUILDER
    FINAL_REVIEW -->|"max retry"| BLOCKED
    FINAL_REVIEW -->|"approve"| COMPLETED

    TASK --> FILE_TOOLS
    TASK --> EDIT_TOOLS
    TASK --> EXEC_TOOLS
    TASK --> MCP_TOOLS
    TASK --> FLOW_TOOLS
    
    DESIGNER <--> USE_MCP
    DESIGNER <--> PARALLEL_UI
    
    USE_MCP --> MCP_HUB
    PARALLEL_MCP --> MCP_HUB
    PARALLEL_UI --> PUI_SERVICE
    ACCESS_RESOURCE --> MCP_HUB
    
    MCP_HUB --> FW_BRIDGE
    MCP_HUB --> TTF
    MCP_HUB --> PP_SERVER
    MCP_HUB --> UI_SERVER
    
    FW_BRIDGE <--> WSS
    WSS <--> UI_HTML
    SANDBOX --> FIGMA_CANVAS
    
    TTF --> FIGMA_CANVAS
    PP_SERVER --> PENPOT_EDITOR
    UI_SERVER --> VSCODE_CHAT
    
    BROWSER_ACTION --> BROWSER_SVC
    QA --> BROWSER_SVC

    %% ================ æ¨£å¼ ================
    style USER_INPUT fill:#6366F1,stroke:#4F46E5,color:#fff
    style SLASH_CMD fill:#818CF8,stroke:#6366F1,color:#fff
    style FSM fill:#8B5CF6,stroke:#7C3AED,color:#fff
    style HANDOFF fill:#A78BFA,stroke:#8B5CF6,color:#fff
    style ACM fill:#A78BFA,stroke:#8B5CF6,color:#fff
    style TASK fill:#7C3AED,stroke:#6D28D9,color:#fff
    style IDLE fill:#6B7280,stroke:#4B5563,color:#fff
    style ARCHITECT fill:#3B82F6,stroke:#1D4ED8,color:#fff
    style DESIGNER fill:#EC4899,stroke:#BE185D,color:#fff
    style DESIGN_REVIEW fill:#F472B6,stroke:#EC4899,color:#fff
    style BUILDER fill:#10B981,stroke:#059669,color:#fff
    style ARCH_REVIEW_CODE fill:#34D399,stroke:#10B981,color:#fff
    style QA fill:#F59E0B,stroke:#D97706,color:#fff
    style TEST_REVIEW fill:#FBBF24,stroke:#F59E0B,color:#fff
    style SENTINEL fill:#EF4444,stroke:#DC2626,color:#fff
    style FINAL_REVIEW fill:#F87171,stroke:#EF4444,color:#fff
    style COMPLETED fill:#22C55E,stroke:#16A34A,color:#fff
    style BLOCKED fill:#991B1B,stroke:#7F1D1D,color:#fff
    style MCP_HUB fill:#4F46E5,stroke:#3730A3,color:#fff
    style PUI_SERVICE fill:#6366F1,stroke:#4F46E5,color:#fff
    style WSS fill:#7C3AED,stroke:#6D28D9,color:#fff
    style FW_BRIDGE fill:#4F46E5,stroke:#3730A3,color:#fff
    style TTF fill:#7C3AED,stroke:#6D28D9,color:#fff
    style PP_SERVER fill:#EC4899,stroke:#BE185D,color:#fff
    style UI_SERVER fill:#10B981,stroke:#059669,color:#fff
    style FIGMA_CANVAS fill:#F59E0B,stroke:#D97706,color:#fff
    style PENPOT_EDITOR fill:#EC4899,stroke:#BE185D,color:#fff
    style VSCODE_CHAT fill:#10B981,stroke:#059669,color:#fff
    style BROWSER_SVC fill:#06B6D4,stroke:#0891B2,color:#fff
```

---

## ğŸ“‹ å·¥å…·åˆ†é¡æ¸…å–®

### ğŸ› ï¸ è‡ªè¨‚ç¾©å·¥å…· (26 å€‹æ ¸å¿ƒå·¥å…·)

| åˆ†é¡           | å·¥å…·åç¨±                   | æè¿°            |
| -------------- | -------------------------- | --------------- |
| **æª”æ¡ˆæ“ä½œ**   | `read_file`                | è®€å–æª”æ¡ˆå…§å®¹    |
|                | `write_to_file`            | å¯«å…¥æª”æ¡ˆ        |
|                | `edit_file`                | ç·¨è¼¯ç¾æœ‰æª”æ¡ˆ    |
|                | `list_files`               | åˆ—å‡ºç›®éŒ„æª”æ¡ˆ    |
|                | `search_files`             | æœå°‹æª”æ¡ˆ        |
|                | `codebase_search`          | ç¨‹å¼ç¢¼åº«æœå°‹    |
| **ç¨‹å¼ç¢¼ä¿®æ”¹** | `apply_diff`               | å¥—ç”¨ diff å·®ç•°  |
|                | `apply_patch`              | å¥—ç”¨è£œä¸        |
|                | `search_replace`           | æœå°‹ä¸¦æ›¿æ›      |
|                | `search_and_replace`       | æœå°‹æ›¿æ› v2     |
|                | `adjust_layout`            | èª¿æ•´ UI ä½ˆå±€    |
| **åŸ·è¡Œ**       | `execute_command`          | åŸ·è¡Œçµ‚ç«¯å‘½ä»¤    |
|                | `start_background_service` | å•Ÿå‹•èƒŒæ™¯æœå‹™    |
|                | `browser_action`           | ç€è¦½å™¨è‡ªå‹•åŒ–    |
|                | `generate_image`           | AI ç”Ÿæˆåœ–ç‰‡     |
| **MCP å·¥å…·**   | `use_mcp_tool`             | èª¿ç”¨ MCP å·¥å…·   |
|                | `parallel_mcp_calls`       | ä¸¦è¡Œ MCP èª¿ç”¨   |
|                | `access_mcp_resource`      | å­˜å– MCP è³‡æº   |
|                | `parallel_ui_tasks`        | ä¸¦è¡Œ UI ä»»å‹™    |
| **æµç¨‹æ§åˆ¶**   | `handoff_context`          | ä»£ç†é–“äº¤æ¥      |
|                | `switch_mode`              | åˆ‡æ› Agent æ¨¡å¼ |
|                | `new_task`                 | å‰µå»ºæ–°ä»»å‹™      |
|                | `attempt_completion`       | å˜—è©¦å®Œæˆä»»å‹™    |
|                | `ask_followup_question`    | è¿½å•å•é¡Œ        |
| **å…¶ä»–**       | `run_slash_command`        | åŸ·è¡Œæ–œç·šå‘½ä»¤    |
|                | `fetch_instructions`       | å–å¾—æŒ‡ä»¤        |
|                | `update_todo_list`         | æ›´æ–°å¾…è¾¦äº‹é …    |

---

### ğŸ”Œ MCP ä¼ºæœå™¨å·¥å…·

#### Figma Write Bridge (40+ å·¥å…·)

| åˆ†é¡         | å·¥å…·                 | æè¿°             |
| ------------ | -------------------- | ---------------- |
| **å‰µå»º**     | `create_frame`       | å»ºç«‹ Frame       |
|              | `create_rectangle`   | å»ºç«‹çŸ©å½¢         |
|              | `create_ellipse`     | å»ºç«‹æ©¢åœ“         |
|              | `create_line`        | å»ºç«‹ç·šæ¢         |
|              | `create_polygon`     | å»ºç«‹å¤šé‚Šå½¢       |
|              | `create_star`        | å»ºç«‹æ˜Ÿå½¢         |
|              | `add_text`           | å»ºç«‹æ–‡å­—         |
|              | `place_image_base64` | æ”¾ç½® Base64 åœ–ç‰‡ |
| **é¸æ“‡**     | `find_nodes`         | æœå°‹ç¯€é»         |
|              | `select_nodes`       | é¸æ“‡ç¯€é»         |
|              | `get_selection`      | å–å¾—ç›®å‰é¸æ“‡     |
|              | `create_page`        | å»ºç«‹é é¢         |
|              | `set_current_page`   | åˆ‡æ›é é¢         |
| **ç¯€é»ç®¡ç†** | `rename_node`        | é‡æ–°å‘½å         |
|              | `delete_node`        | åˆªé™¤ç¯€é»         |
|              | `duplicate_node`     | è¤‡è£½ç¯€é»         |
|              | `resize_node`        | èª¿æ•´å¤§å°         |
|              | `rotate_node`        | æ—‹è½‰             |
|              | `set_position`       | è¨­å®šä½ç½®         |
|              | `group_nodes`        | ç¾¤çµ„             |
|              | `ungroup`            | è§£æ•£ç¾¤çµ„         |
| **æ¨£å¼**     | `set_fill`           | è¨­å®šå¡«è‰²         |
|              | `set_stroke`         | è¨­å®šé‚Šæ¡†         |
|              | `set_corner_radius`  | è¨­å®šåœ“è§’         |
|              | `set_opacity`        | è¨­å®šé€æ˜åº¦       |
|              | `set_blend_mode`     | è¨­å®šæ··åˆæ¨¡å¼     |
|              | `add_effect`         | æ–°å¢æ•ˆæœ         |
|              | `clear_effects`      | æ¸…é™¤æ•ˆæœ         |
|              | `layout_grid_add`    | æ–°å¢ä½ˆå±€æ ¼ç·š     |
|              | `layout_grid_clear`  | æ¸…é™¤ä½ˆå±€æ ¼ç·š     |
| **ä½ˆå±€**     | `set_auto_layout`    | è¨­å®š Auto Layout |
|              | `set_constraints`    | è¨­å®šç´„æŸ         |
| **æ–‡å­—**     | `set_text_content`   | è¨­å®šæ–‡å­—å…§å®¹     |
|              | `set_text_style`     | è¨­å®šæ–‡å­—æ¨£å¼     |
|              | `set_text_color`     | è¨­å®šæ–‡å­—é¡è‰²     |
| **å…ƒä»¶**     | `create_component`   | å»ºç«‹å…ƒä»¶         |
|              | `create_instance`    | å»ºç«‹å¯¦ä¾‹         |
|              | `detach_instance`    | åˆ†é›¢å¯¦ä¾‹         |
|              | `boolean_op`         | å¸ƒæ—é‹ç®—         |
| **åŒ¯å‡º**     | `export_node`        | åŒ¯å‡ºç¯€é»         |
|              | `set_plugin_data`    | è¨­å®šæ’ä»¶è³‡æ–™     |
|              | `get_plugin_data`    | å–å¾—æ’ä»¶è³‡æ–™     |
|              | `set_properties`     | æ‰¹æ¬¡è¨­å®šå±¬æ€§     |

#### MCP-UI Server (10 å·¥å…·)

| å·¥å…·                | æè¿°           |
| ------------------- | -------------- |
| `render_button`     | æ¸²æŸ“æŒ‰éˆ•       |
| `render_card`       | æ¸²æŸ“å¡ç‰‡       |
| `render_table`      | æ¸²æŸ“è¡¨æ ¼       |
| `render_progress`   | æ¸²æŸ“é€²åº¦æ¢     |
| `render_alert`      | æ¸²æŸ“è­¦å‘Šè¨Šæ¯   |
| `render_code_block` | æ¸²æŸ“ç¨‹å¼ç¢¼å€å¡Š |
| `render_list`       | æ¸²æŸ“æ¸…å–®       |
| `render_badge`      | æ¸²æŸ“æ¨™ç±¤       |
| `render_divider`    | æ¸²æŸ“åˆ†éš”ç·š     |
| `render_stats`      | æ¸²æŸ“çµ±è¨ˆæ•¸æ“š   |

#### Penpot MCP

| é€£æ¥åŸ            | ç”¨é€”                    |
| ---------------- | ----------------------- |
| `localhost:4401` | HTTP/SSE MCP å®¢æˆ¶ç«¯é€£ç·š |
| `localhost:4402` | WebSocket Plugin é€£ç·š   |
| `localhost:4403` | REPL é–‹ç™¼é™¤éŒ¯           |

#### TalkToFigma (å¤–éƒ¨)

| åˆ†é¡         | å·¥å…·                                                                |
| ------------ | ------------------------------------------------------------------- |
| **æ–‡ä»¶æ“ä½œ** | `get_document_info`, `get_selection`, `get_node_info`               |
| **å‰µå»º**     | `create_frame`, `create_rectangle`, `create_text`, `create_ellipse` |
| **æ¨£å¼**     | `set_fill_color`, `set_corner_radius`, `set_stroke`                 |
| **ä½ˆå±€**     | `move_node`, `resize_node`, `set_auto_layout`                       |
| **å…ƒä»¶**     | `get_local_components`, `create_component_instance`                 |
| **åŒ¯å‡º**     | `export_node_as_image`, `get_styles`                                |

---

## ğŸ”„ ç‹€æ…‹æ©Ÿè½‰æ›è©³åœ–

```mermaid
stateDiagram-v2
    [*] --> IDLE: åˆå§‹åŒ–

    IDLE --> ARCHITECT: start()

    state "Phase 1: è¦åŠƒè¨­è¨ˆ" as P1 {
        ARCHITECT --> DESIGNER: needsDesign=true<br/>useFigma=true
        ARCHITECT --> BUILDER: needsDesign=false

        DESIGNER --> DESIGN_REVIEW: designSpecs å®Œæˆ
        DESIGN_REVIEW --> DESIGNER: è¨­è¨ˆè¢«æ‹’ (é‡è©¦ â‰¤3)
        DESIGN_REVIEW --> BUILDER: è¨­è¨ˆé€šé
        DESIGN_REVIEW --> BLOCKED: é‡è©¦ > 3
    }

    state "Phase 2: å¯¦ä½œ" as P2 {
        BUILDER --> ARCHITECT_REVIEW_CODE: builderTestContext å®Œæˆ
        ARCHITECT_REVIEW_CODE --> BUILDER: ç¨‹å¼ç¢¼è¢«æ‹’
        ARCHITECT_REVIEW_CODE --> QA: ç¨‹å¼ç¢¼é€šé
    }

    state "Phase 3: æ¸¬è©¦" as P3 {
        QA --> ARCHITECT_REVIEW_TESTS: qaAuditContext å®Œæˆ
        ARCHITECT_REVIEW_TESTS --> BUILDER: æ¸¬è©¦å¤±æ•— (é‡è©¦ â‰¤3)
        ARCHITECT_REVIEW_TESTS --> SENTINEL: æ¸¬è©¦é€šé
        ARCHITECT_REVIEW_TESTS --> BLOCKED: é‡è©¦ > 3
    }

    state "Phase 4: å®‰å…¨" as P4 {
        SENTINEL --> ARCHITECT_REVIEW_FINAL: sentinelResult å®Œæˆ
        ARCHITECT_REVIEW_FINAL --> BUILDER: æœ‰æ¼æ´ (é‡è©¦ â‰¤2)
        ARCHITECT_REVIEW_FINAL --> COMPLETED: å®‰å…¨é€šé
        ARCHITECT_REVIEW_FINAL --> BLOCKED: é‡è©¦ > 2
    }

    COMPLETED --> [*]: ä»»å‹™å®Œæˆ
    BLOCKED --> [*]: éœ€äººå·¥ä»‹å…¥
```

---

## ğŸ”— MCP è«‹æ±‚-å›æ‡‰å®Œæ•´åºåˆ—

```mermaid
sequenceDiagram
    autonumber
    participant Agent as ğŸ¤– Agent (Designer/Builder/QA)
    participant Task as ğŸ“‹ Task
    participant UseMcp as ğŸ”§ UseMcpToolTool
    participant McpHub as ğŸ›ï¸ McpHub
    participant Transport as ğŸ“¡ Transport (stdio/SSE)
    participant MCP as ğŸ”Œ MCP Server
    participant WS as ğŸŒ‰ WebSocket Bridge
    participant Plugin as ğŸ§© Figma Plugin
    participant Canvas as ğŸ¨ Figma Canvas

    rect rgb(240, 240, 255)
        Note over Agent,Canvas: === Phase 1: å·¥å…·èª¿ç”¨ç™¼èµ· ===
        Agent->>Task: åŸ·è¡Œå·¥å…· use_mcp_tool
        Task->>UseMcp: execute(params)
        UseMcp->>UseMcp: validateParams()<br/>validateToolExists()
    end

    rect rgb(240, 255, 240)
        Note over Agent,Canvas: === Phase 2: MCP å”è­°è™•ç† ===
        UseMcp->>McpHub: callTool(serverName, toolName, args)
        McpHub->>McpHub: getConnection(serverName)
        McpHub->>Transport: send(request)
        Transport->>MCP: JSON-RPC Request
    end

    rect rgb(255, 240, 240)
        Note over Agent,Canvas: === Phase 3: Figma æ“ä½œåŸ·è¡Œ ===
        MCP->>MCP: Zod schema validation
        MCP->>WS: sendToPlugin(action, args)
        WS->>WS: generateId()<br/>pending.set(id, {resolve, reject})
        WS->>Plugin: ws.send({id, action, args})
        Plugin->>Plugin: handleAction(action)
        Plugin->>Canvas: figma.createFrame() etc.
        Canvas-->>Plugin: Node created
    end

    rect rgb(255, 255, 240)
        Note over Agent,Canvas: === Phase 4: å›æ‡‰è¿”å› ===
        Plugin->>Plugin: æº–å‚™å›æ‡‰ {ok:true, nodeId}
        Plugin->>WS: figma.ui.postMessage({replyTo:id, result})
        WS->>WS: pending.get(id).resolve(result)
        WS-->>MCP: Promise resolved
        MCP-->>Transport: JSON-RPC Response
        Transport-->>McpHub: Result
        McpHub-->>UseMcp: toolResult
        UseMcp->>UseMcp: processToolContent()
        UseMcp-->>Task: å·¥å…·çµæœ
        Task-->>Agent: ç¹¼çºŒåŸ·è¡Œ
    end
```

---

## ğŸ“Š å·¥å…·æ˜ å°„è¡¨ (ParallelUIService)

ParallelUIService è™•ç† `figma-write` èˆ‡ `TalkToFigma` ä¹‹é–“çš„å·¥å…·åç¨±å’Œåƒæ•¸å·®ç•°ï¼š

| figma-write         | TalkToFigma         | åƒæ•¸å·®ç•°                 |
| ------------------- | ------------------- | ------------------------ |
| `add_text`          | `create_text`       | -                        |
| `set_text_color`    | `set_fill_color`    | -                        |
| `set_fill`          | `set_fill_color`    | `hex` â†’ `color: {r,g,b}` |
| `set_position`      | `move_node`         | -                        |
| `resize_node`       | `resize_node`       | ç›¸åŒ                     |
| `set_corner_radius` | `set_corner_radius` | ç›¸åŒ                     |

---

## ğŸ“ æ ¸å¿ƒæª”æ¡ˆç´¢å¼•

| æª”æ¡ˆ                                             | è¡Œæ•¸   | è·è²¬                   |
| ------------------------------------------------ | ------ | ---------------------- |
| [src/services/mcp/McpHub.ts](file:///Users/vito/Documents/GitHub/agentic%20AI%20agent/src/services/mcp/McpHub.ts)                     | 3,700+ | MCP ä¼ºæœå™¨ç”Ÿå‘½é€±æœŸç®¡ç† |
| [src/core/sentinel/StateMachine.ts](file:///Users/vito/Documents/GitHub/agentic%20AI%20agent/src/core/sentinel/StateMachine.ts)              | 1,200+ | Multi-Agent ç‹€æ…‹æ©Ÿ     |
| [src/services/figma/ParallelUIService.ts](file:///Users/vito/Documents/GitHub/agentic%20AI%20agent/src/services/figma/ParallelUIService.ts)        | 2,600+ | ä¸¦è¡Œ UI ä»»å‹™å”èª¿       |
| [src/services/figma/AgentContextManager.ts](file:///Users/vito/Documents/GitHub/agentic%20AI%20agent/src/services/figma/AgentContextManager.ts)      | 330+   | Agent ä¸Šä¸‹æ–‡éš”é›¢       |
| [src/core/sentinel/HandoffContext.ts](file:///Users/vito/Documents/GitHub/agentic%20AI%20agent/src/core/sentinel/HandoffContext.ts)            | 210+   | ä»£ç†é–“è³‡æ–™äº¤æ¥         |
| [tools/figma-write-bridge/figma-write-bridge.ts](file:///Users/vito/Documents/GitHub/agentic%20AI%20agent/tools/figma-write-bridge/figma-write-bridge.ts) | 318    | Figma MCP ä¼ºæœå™¨       |
| [tools/figma-write-bridge/plugin/plugin.js](file:///Users/vito/Documents/GitHub/agentic%20AI%20agent/tools/figma-write-bridge/plugin/plugin.js)      | 400+   | Figma Plugin æ²™ç›’      |
| [src/core/tools/UseMcpToolTool.ts](file:///Users/vito/Documents/GitHub/agentic%20AI%20agent/src/core/tools/UseMcpToolTool.ts)               | 690+   | MCP å·¥å…·èª¿ç”¨           |
| [src/core/tools/ParallelUITasksTool.ts](file:///Users/vito/Documents/GitHub/agentic%20AI%20agent/src/core/tools/ParallelUITasksTool.ts)          | 1,200+ | ä¸¦è¡Œ UI ä»»å‹™å·¥å…·       |
